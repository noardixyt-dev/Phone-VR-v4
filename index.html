<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Stereo Viewer — MetaQuest-style Menu + Hand Tracking</title>
<style>
  :root { --outline: rgba(255,255,255,0.06); }
  html,body{margin:0;padding:0;height:100%;width:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
  canvas#overlay{position:fixed;left:0;top:0;width:100%;height:100%;z-index:40;pointer-events:none;display:block}
  #stereoWrap{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;gap:var(--gap,12px);pointer-events:none;z-index:10}
  .eyeWin{width:var(--eye-w,360px);height:var(--eye-h,202px);border-radius:14px;overflow:hidden;border:2px solid var(--outline);box-shadow:0 6px 22px rgba(0,0,0,0.6);background:#000;position:relative}
  .eyeVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform-origin:center center}
  #controls{position:fixed;left:12px;top:10px;z-index:60;display:flex;gap:10px;align-items:center;pointer-events:auto;transition:opacity .32s,transform .32s}
  #controls.hidden{opacity:0;pointer-events:none;transform:translateY(-8px)}
  .control{background:rgba(0,0,0,0.45);backdrop-filter:blur(6px);padding:8px;border-radius:8px;font-size:13px;color:#fff}
  #fovSlider{width:220px}
  #fullscreenBtn{position:fixed;top:10px;right:10px;z-index:60;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);color:#fff;font-size:14px;pointer-events:auto;display:none}
  #startBtn{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:80;padding:14px 18px;border-radius:10px;background:#111;color:#fff;border:1px solid rgba(255,255,255,0.06);cursor:pointer}
  #hint{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);font-size:12px;background:rgba(0,0,0,0.35);padding:6px 10px;border-radius:8px;z-index:60}
  #portraitOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);z-index:120;color:#fff;font-size:20px;padding:20px;text-align:center;pointer-events:auto}
</style>
</head>
<body>
  <button id="startBtn">Start VR (camera & motion)</button>

  <div id="controls" class="hidden" style="display:none">
    <div class="control">
      <div style="font-size:12px;margin-bottom:6px">FOV (eye window) <span id="fovVal">70%</span></div>
      <input id="fovSlider" type="range" min="40" max="100" value="70" />
    </div>
  </div>

  <button id="fullscreenBtn">Fullscreen</button>
  <div id="hint">Double-tap to toggle menu • Tap top to show UI</div>
  <div id="portraitOverlay">Please rotate your device to landscape</div>

  <div id="stereoWrap" aria-hidden="true">
    <div id="leftWin" class="eyeWin"><video id="videoLeft" class="eyeVideo" playsinline autoplay muted></video></div>
    <div id="rightWin" class="eyeWin"><video id="videoRight" class="eyeVideo" playsinline autoplay muted></video></div>
  </div>

  <canvas id="overlay"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const startBtn = document.getElementById('startBtn');
const controls = document.getElementById('controls');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const fovSlider = document.getElementById('fovSlider');
const fovVal = document.getElementById('fovVal');

const leftWin = document.getElementById('leftWin');
const rightWin = document.getElementById('rightWin');
const videoLeft = document.getElementById('videoLeft');
const videoRight = document.getElementById('videoRight');
const overlay = document.getElementById('overlay');
const portraitOverlay = document.getElementById('portraitOverlay');

let stream = null;
let eyeScalePct = parseFloat(fovSlider.value);
fovVal.textContent = Math.round(eyeScalePct) + '%';

function layoutEyes(){
  const scale = Math.max(0.3, Math.min(1.0, eyeScalePct/100));
  let eyeH = Math.round(window.innerHeight * scale);
  let eyeW = Math.floor(eyeH * 16/9);
  if (eyeW * 2 > window.innerWidth){
    eyeW = Math.floor(window.innerWidth / 2);
    eyeH = Math.floor(eyeW * 9/16);
  }
  document.documentElement.style.setProperty('--eye-w', eyeW + 'px');
  document.documentElement.style.setProperty('--eye-h', eyeH + 'px');

  // Vertically center
  const wrapTop = (window.innerHeight - eyeH)/2;
  document.getElementById('stereoWrap').style.top = wrapTop + 'px';
}

function updatePortrait(){
  if(window.innerHeight > window.innerWidth) portraitOverlay.style.display='flex';
  else portraitOverlay.style.display='none';
}

window.addEventListener('resize',()=>{ layoutEyes(); updatePortrait(); if(renderer){ renderer.setSize(window.innerWidth, window.innerHeight); perspectiveBase.aspect = window.innerWidth/window.innerHeight; perspectiveBase.updateProjectionMatrix(); } });
layoutEyes();
updatePortrait();

// Camera start
startBtn.addEventListener('click', async ()=>{
  startBtn.style.display='none';
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    videoLeft.srcObject = stream;
    videoRight.srcObject = stream;
    await videoLeft.play();
    await videoRight.play();
    controls.style.display='flex';
    fullscreenBtn.style.display='block';
    initThreeOverlay();
    initHandTracking();
  }catch(e){ alert('Camera error '+e); startBtn.style.display='block'; }
});

// Fullscreen
fullscreenBtn.addEventListener('click',()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });

// FOV slider
fovSlider.addEventListener('input',()=>{
  eyeScalePct = parseFloat(fovSlider.value);
  fovVal.textContent = Math.round(eyeScalePct) + '%';
  layoutEyes();
  if(menuMesh) menuMesh.scale.setScalar(eyeScalePct/70);
});

// 3D scene single-pass
let renderer, scene3D, perspectiveBase, menuMesh=null, menuBar=null;
function initThreeOverlay(){
  renderer = new THREE.WebGLRenderer({canvas:overlay,antialias:true,alpha:true});
  renderer.setPixelRatio(window.devicePixelRatio||1);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.autoClear=false;

  scene3D = new THREE.Scene();
  scene3D.add(new THREE.AmbientLight(0xffffff,0.8));
  const dl = new THREE.DirectionalLight(0xffffff,0.25); dl.position.set(1,2,2); scene3D.add(dl);

  perspectiveBase = new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.01,1000);
  camLeft = perspectiveBase.clone();
  camRight = perspectiveBase.clone();

  // MetaQuest-style menu
  const menuG = new THREE.BoxGeometry(0.64,0.36,0.02);
  const menuM = new THREE.MeshStandardMaterial({color:0x1f6feb,roughness:0.5,metalness:0.05,emissive:0x001030});
  menuMesh = new THREE.Mesh(menuG,menuM);
  menuMesh.visible=false;
  scene3D.add(menuMesh);

  const barG = new THREE.BoxGeometry(0.28,0.028,0.002);
  const barM = new THREE.MeshStandardMaterial({color:0xffffff,transparent:true,opacity:0.9});
  menuBar = new THREE.Mesh(barG,barM);
  menuBar.position.set(0,-0.20,0.012);
  menuMesh.add(menuBar);

  overlay.addEventListener('pointerdown',overlayPointerDown);
  overlay.addEventListener('pointermove',overlayPointerMove);
  overlay.addEventListener('pointerup',overlayPointerUp);

  window.addEventListener('dblclick',toggleMenu);

  animate();
}

function toggleMenu(){
  if(!menuMesh) return;
  menuMesh.visible=!menuMesh.visible;
}

// Drag
let dragging=false, dragOffset=new THREE.Vector3();
function overlayPointerDown(e){
  if(!menuMesh.visible) return;
  const rect = overlay.getBoundingClientRect();
  const mouse = new THREE.Vector2((e.clientX-rect.left)/rect.width*2-1,-((e.clientY-rect.top)/rect.height)*2+1);
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse,perspectiveBase);
  const hits = raycaster.intersectObject(menuBar);
  if(hits.length>0){
    dragging=true;
    dragOffset.copy(menuMesh.position);
  }
}
function overlayPointerMove(e){
  if(!dragging) return;
}
function overlayPointerUp(e){ dragging=false; }

// Animate
function animate(){
  requestAnimationFrame(animate);
  renderer.clear();
  renderer.render(scene3D,perspectiveBase);
}

// Hand tracking
let hands=null, mpCamera=null;
function initHandTracking(){
  hands = new Hands({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
  hands.setOptions({maxNumHands:1,minDetectionConfidence:0.8,minTrackingConfidence:0.8});
  hands.onResults(onHandsResults);

  mpCamera = new Camera(videoLeft,{onFrame:async()=>{await hands.send({image:videoLeft});},width:640,height:480});
  mpCamera.start();
}

let isPinching=false;
function onHandsResults(results){
  const ctx = overlay.getContext('2d');
  ctx.clearRect(0,0,overlay.width,overlay.height);

  if(results.multiHandLandmarks.length>0 && menuMesh.visible){
    const lm = results.multiHandLandmarks[0];
    const palmX = (lm[0].x-0.5)*2;
    const palmY = -(lm[0].y-0.5)*2;
    const dotX = lm[0].x*overlay.width;
    const dotY = lm[0].y*overlay.height;

    // Draw palm dot with glow
    ctx.fillStyle='white';
    ctx.shadowColor='white';
    ctx.shadowBlur=12;
    ctx.beginPath();
    ctx.arc(dotX,dotY,10,0,Math.PI*2);
    ctx.fill();

    // Pinch detection
    const dx = lm[4].x-lm[8].x, dy=lm[4].y-lm[8].y;
    const pinchDist = Math.sqrt(dx*dx+dy*dy);
    const THRESH=0.05;

    if(pinchDist<THRESH){
      if(!isPinching){
        isPinching=true;
        dragOffset.copy(menuMesh.position).sub(new THREE.Vector3(palmX,palmY,menuMesh.position.z));
      }
      menuMesh.position.x=THREE.MathUtils.clamp(palmX+dragOffset.x,-1,1);
      menuMesh.position.y=THREE.MathUtils.clamp(palmY+dragOffset.y,-0.8,0.8);
    }else{isPinching=false;}
  }else{isPinching=false;}
}
</script>
</body>
</html>
