<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>Stereo Viewer (3DOF menu, top UI)</title>
<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:sans-serif;}
#fovControl{position:absolute;top:10px;left:10px;z-index:100;background:rgba(0,0,0,0.4);padding:6px 10px;border-radius:10px;display:flex;align-items:center;gap:8px;transition:opacity .3s;}
#fullscreenBtn{position:absolute;top:10px;right:10px;z-index:100;background:rgba(0,0,0,0.4);padding:8px 12px;border-radius:10px;color:#fff;border:1px solid rgba(255,255,255,0.2);font-size:14px;transition:opacity .3s;}
.hiddenUI{opacity:0;pointer-events:none;}
#startBtn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:14px 20px;border-radius:10px;background:#111;color:#fff;z-index:200;border:1px solid rgba(255,255,255,0.06);font-size:16px;}
#portraitOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);color:#fff;font-size:20px;z-index:300;display:none;}
.eyeOutline{position:absolute;border:1px solid rgba(255,255,255,0.3);border-radius:6px;pointer-events:none;}
video{display:none;}
canvas{position:absolute;top:0;left:0;}
</style>
</head>
<body>
<div id="fovControl">
  <span>FOV</span>
  <input id="fovSlider" type="range" min="40" max="100" value="70"/>
  <span id="fovVal">70%</span>
</div>
<button id="fullscreenBtn">Fullscreen</button>
<button id="startBtn">Start</button>
<div id="portraitOverlay">Rotate to landscape</div>
<div id="leftEye" class="eyeOutline"></div>
<div id="rightEye" class="eyeOutline"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script>
/* ---------- Elements ---------- */
const fovSlider=document.getElementById('fovSlider');
const fovVal=document.getElementById('fovVal');
const fovControl=document.getElementById('fovControl');
const fullscreenBtn=document.getElementById('fullscreenBtn');
const startBtn=document.getElementById('startBtn');
const portraitOverlay=document.getElementById('portraitOverlay');
const leftEye=document.getElementById('leftEye');
const rightEye=document.getElementById('rightEye');

/* ---------- UI hiding logic ---------- */
let hideTimer=null;
const HIDE_MS=10000;
function showUI(){
  fovControl.classList.remove('hiddenUI');
  fullscreenBtn.classList.remove('hiddenUI');
  resetHideTimer();
}
function hideUI(){
  fovControl.classList.add('hiddenUI');
  fullscreenBtn.classList.add('hiddenUI');
}
function resetHideTimer(){
  if(hideTimer) clearTimeout(hideTimer);
  hideTimer=setTimeout(hideUI,HIDE_MS);
}
document.body.addEventListener('pointerdown',(e)=>{
  const x=e.clientX, y=e.clientY;
  if(y<80 && (x<100 || x>window.innerWidth-100)) showUI();
});

/* ---------- Core setup ---------- */
let scene3D, camL, camR, baseCam, renderer;
let menuMesh, cursor;
let deviceQuat=new THREE.Quaternion();
let deviceActive=false;
const MENU_DISTANCE=1.3;
const FIXED_IPD=0.065;

let video, videoTex, videoPlane, sceneVideo, orthoCam;
let rtL, rtR, postScene, postMat, postCam;
let fovScale=parseFloat(fovSlider.value);
fovVal.textContent=fovScale+'%';

/* ---------- Device orientation (landscape) ---------- */
const zee=new THREE.Vector3(0,0,1);
const euler=new THREE.Euler();
const qPortraitToThree=new THREE.Quaternion(-Math.sqrt(0.5),0,0,Math.sqrt(0.5));
function getOrientationAngle(){return (screen.orientation && screen.orientation.angle)||0;}
function setQuat(q,alpha,beta,gamma){
  const deg2rad=Math.PI/180;
  euler.set(beta*deg2rad,alpha*deg2rad,-gamma*deg2rad,'YXZ');
  q.setFromEuler(euler);
  const orient=getOrientationAngle();
  let base=new THREE.Quaternion();
  if(orient===90) base.setFromAxisAngle(zee,-Math.PI/2);
  else if(orient===270) base.setFromAxisAngle(zee,Math.PI/2);
  q.multiply(qPortraitToThree).multiply(base);
  const e=new THREE.Euler().setFromQuaternion(q,'YXZ');
  e.z=0; q.setFromEuler(e);
}
async function enableDeviceOrientation(){
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    try{
      const p=await DeviceOrientationEvent.requestPermission();
      if(p==='granted'){
        window.addEventListener('deviceorientation',ev=>{
          deviceActive=true; setQuat(deviceQuat,ev.alpha,ev.beta,ev.gamma);
        },true);
      }
    }catch(e){}
  }else{
    window.addEventListener('deviceorientation',ev=>{
      deviceActive=true; setQuat(deviceQuat,ev.alpha,ev.beta,ev.gamma);
    },true);
  }
}

/* ---------- Start sequence ---------- */
startBtn.addEventListener('click',async()=>{
  startBtn.style.display='none';
  await enableDeviceOrientation();
  showUI();
  try{
    video=document.createElement('video');
    video.setAttribute('playsinline','');
    video.autoplay=true; video.muted=true;
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    video.srcObject=stream;
    video.addEventListener('loadedmetadata',()=>init(),{once:true});
  }catch(e){alert('Camera error: '+e.message); startBtn.style.display='block';}
});

/* ---------- Initialization ---------- */
function init(){
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.body.appendChild(renderer.domElement);
  scene3D=new THREE.Scene();
  scene3D.add(new THREE.AmbientLight(0xffffff,0.6));
  const d=new THREE.DirectionalLight(0xffffff,0.5);d.position.set(1,1,1);scene3D.add(d);
  baseCam=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.01,100);
  camL=baseCam.clone(); camR=baseCam.clone();

  // Menu
  const g=new THREE.BoxGeometry(0.4,0.2,0.05);
  const m=new THREE.MeshStandardMaterial({color:0x2f7fff});
  menuMesh=new THREE.Mesh(g,m); menuMesh.visible=false; scene3D.add(menuMesh);

  // Cursor
  const rg=new THREE.RingGeometry(0.01,0.02,32);
  const rm=new THREE.MeshBasicMaterial({color:0xffffff,side:THREE.DoubleSide});
  cursor=new THREE.Mesh(rg,rm); cursor.visible=false; scene3D.add(cursor);

  // Video scene
  sceneVideo=new THREE.Scene();
  orthoCam=new THREE.OrthographicCamera(0,window.innerWidth,0,window.innerHeight,-10,10);
  videoTex=new THREE.VideoTexture(video);
  const vmat=new THREE.MeshBasicMaterial({map:videoTex});
  videoPlane=new THREE.Mesh(new THREE.PlaneGeometry(1,1),vmat);
  sceneVideo.add(videoPlane);

  // Render targets
  rtL=new THREE.WebGLRenderTarget(1024,1024);
  rtR=new THREE.WebGLRenderTarget(1024,1024);

  // Post process (basic)
  postMat=new THREE.MeshBasicMaterial({map:null});
  postScene=new THREE.Scene();
  postCam=new THREE.Camera();
  const fs=new THREE.PlaneGeometry(2,2);
  const postMesh=new THREE.Mesh(fs,postMat);
  postScene.add(postMesh);

  window.addEventListener('resize',onResize);
  onResize();

  document.addEventListener('dblclick',toggleMenu);
  fullscreenBtn.addEventListener('click',()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen(); showUI();});
  fovSlider.addEventListener('input',()=>{fovScale=parseFloat(fovSlider.value);fovVal.textContent=fovScale+'%';onResize();showUI();});

  animate();
}

/* ---------- Resize ---------- */
let eye={};
function computeEyes(){
  const scale=fovScale/100;
  const eyeH=Math.round(window.innerHeight*scale);
  const aspect=(video.videoWidth/video.videoHeight)||1.777;
  let eyeW=Math.round(eyeH*aspect);
  const gap=Math.round(eyeW*0.08);
  if(eyeW*2+gap>window.innerWidth){
    const avail=window.innerWidth-gap;
    eyeW=Math.round(avail/2);
  }
  const leftX=(window.innerWidth-eyeW*2-gap)/2;
  const rightX=leftX+eyeW+gap;
  const y=(window.innerHeight-eyeH)/2;
  eye={eyeW,eyeH,leftX,rightX,y,gap};
  leftEye.style.cssText=`left:${leftX}px;top:${y}px;width:${eyeW}px;height:${eyeH}px;`;
  rightEye.style.cssText=`left:${rightX}px;top:${y}px;width:${eyeW}px;height:${eyeH}px;`;
}
function onResize(){
  renderer.setSize(window.innerWidth,window.innerHeight);
  baseCam.aspect=window.innerWidth/window.innerHeight;baseCam.updateProjectionMatrix();
  computeEyes();
  const isLandscape=window.innerWidth>window.innerHeight;
  portraitOverlay.style.display=isLandscape?'none':'flex';
}

/* ---------- Menu toggle ---------- */
function toggleMenu(){
  const show=!menuMesh.visible;
  menuMesh.visible=show;cursor.visible=show;
  if(show){
    const dir=new THREE.Vector3(0,0,-1).applyQuaternion(deviceActive?deviceQuat:baseCam.quaternion);
    menuMesh.position.copy(dir.multiplyScalar(MENU_DISTANCE));
  }
}

/* ---------- Render loop ---------- */
function animate(){
  requestAnimationFrame(animate);
  if(!renderer)return;
  if(video.readyState>=2) videoTex.needsUpdate=true;
  if(deviceActive) baseCam.quaternion.copy(deviceQuat);
  camL.quaternion.copy(baseCam.quaternion);
  camR.quaternion.copy(baseCam.quaternion);
  camL.position.set(-FIXED_IPD/2,0,0);
  camR.position.set(FIXED_IPD/2,0,0);

  // render both eyes
  const v=eye;
  const dpr=window.devicePixelRatio||1;
  const w=v.eyeW*dpr,h=v.eyeH*dpr;
  rtL.setSize(w,h);rtR.setSize(w,h);

  // video left
  renderer.setRenderTarget(rtL);
  videoPlane.position.set(v.leftX+v.eyeW/2,v.y+v.eyeH/2,0);
  videoPlane.scale.set(v.eyeW,v.eyeH,1);
  renderer.render(sceneVideo,orthoCam);
  renderer.setRenderTarget(null);

  // video right
  renderer.setRenderTarget(rtR);
  videoPlane.position.set(v.rightX+v.eyeW/2,v.y+v.eyeH/2,0);
  videoPlane.scale.set(v.eyeW,v.eyeH,1);
  renderer.render(sceneVideo,orthoCam);
  renderer.setRenderTarget(null);

  // draw left
  renderer.setViewport(v.leftX,v.y,v.eyeW,v.eyeH);
  postMat.map=rtL.texture;
  renderer.render(postScene,postCam);
  renderer.setViewport(v.rightX,v.y,v.eyeW,v.eyeH);
  postMat.map=rtR.texture;
  renderer.render(postScene,postCam);

  // render 3D overlay
  renderer.setScissorTest(true);
  renderer.setScissor(v.leftX,v.y,v.eyeW,v.eyeH);
  renderer.setViewport(v.leftX,v.y,v.eyeW,v.eyeH);
  renderer.render(scene3D,camL);
  renderer.setScissor(v.rightX,v.y,v.eyeW,v.eyeH);
  renderer.setViewport(v.rightX,v.y,v.eyeW,v.eyeH);
  renderer.render(scene3D,camR);
  renderer.setScissorTest(false);
}
</script>
</body>
</html>
