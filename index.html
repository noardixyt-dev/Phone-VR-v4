<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VR Menu with WebXR</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: #000;
    }
    #vr-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .eye-container {
      position: absolute;
      width: 45%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .menu {
      position: absolute;
      width: 200px;
      height: 100px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      color: #000;
      pointer-events: none;
      visibility: hidden;
    }
  </style>
</head>
<body>

<div id="vr-container">
  <div id="left-eye-container" class="eye-container">
    <video id="left-eye" autoplay muted playsinline></video>
    <div class="menu" id="menu-left">VR Menu</div>
  </div>
  <div id="right-eye-container" class="eye-container">
    <video id="right-eye" autoplay muted playsinline></video>
    <div class="menu" id="menu-right">VR Menu</div>
  </div>
</div>

<script>
  const leftEye = document.getElementById('left-eye');
  const rightEye = document.getElementById('right-eye');
  const leftContainer = document.getElementById('left-eye-container');
  const rightContainer = document.getElementById('right-eye-container');
  const menuLeft = document.getElementById('menu-left');
  const menuRight = document.getElementById('menu-right');

  let currentYaw = 0, currentPitch = 0;
  let menuSpawned = false;
  let menuWorldYaw = 0, menuWorldPitch = 0;
  let menuPos = {xL: 0, yL: 0, xR: 0, yR: 0};
  const smoothing = 0.22;
  const horizontalSensitivity = 2.05;

  // Initialize WebXR
  async function initXR() {
    if (!navigator.xr) {
      alert("WebXR is not supported by your browser.");
      return;
    }

    try {
      const session = await navigator.xr.requestSession('immersive-vr');
      session.addEventListener('end', () => {
        alert("VR session ended.");
      });

      const referenceSpace = await session.requestReferenceSpace('local');
      const viewerPose = await session.requestViewerPose(referenceSpace);

      // Handle head tracking and menu positioning here
      session.requestAnimationFrame((time, frame) => {
        const pose = frame.getViewerPose(referenceSpace);
        if (pose) {
          const orientation = pose.transform.orientation;
          currentYaw = Math.atan2(2 * (orientation.w * orientation.z + orientation.x * orientation.y), 1 - 2 * (orientation.y * orientation.y + orientation.z * orientation.z));
          currentPitch = Math.asin(2 * (orientation.w * orientation.y - orientation.z * orientation.x));

          if (menuSpawned) {
            updateMenuPosition();
          }
        }
        session.requestAnimationFrame(arguments.callee);
      });
    } catch (err) {
      console.error("Failed to start XR session:", err);
    }
  }

  // Start camera
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' },
        audio: false
      });
      leftEye.srcObject = stream;
      rightEye.srcObject = stream;
      leftEye.onloadedmetadata = rightEye.onloadedmetadata = () => {
        leftEye.play();
        rightEye.play();
      };
    } catch (err) {
      alert("Camera access denied.");
      console.error(err);
    }
  }
  startCamera();

  // Fullscreen
  document.getElementById('fullscreen-btn').addEventListener('click', () => {
    if (document.fullscreenElement) {
      document.exitFullscreen();
    } else {
      document.documentElement.requestFullscreen();
    }
  });

  // Device orientation
  window.addEventListener('deviceorientation', e => {
    if (e.alpha !== null && e.beta !== null) {
      currentYaw = e.alpha;
      currentPitch = e.beta;
      if (menuSpawned) {
        updateMenuPosition();
      }
    }
  });

  // Double tap to spawn menu
  let lastTap = 0;
  window.addEventListener('touchend', e => {
    const now = new Date().getTime();
    if (now - lastTap < 300 && now - lastTap > 0) {
      spawnMenu();
      e.preventDefault();
      e.stopPropagation();
    }
    lastTap = now;
  });

  function spawnMenu() {
    menuSpawned = true;
    menuWorldYaw = currentYaw;
    menuWorldPitch = currentPitch;
  }

  // Lerp helper
  function lerp(a, b, t) {
    return a + (b - a) * t;
  }

  // Convert world yaw/pitch to screen coordinates
  function worldToScreen(menuYaw, menuPitch, rect) {
    const fovH = 100;
    let deltaYaw = menuYaw - currentYaw;
    deltaYaw = ((deltaYaw + 540) % 360) - 180;
    const x = rect.width / 2 - (deltaYaw / (fovH / 2)) * (rect.width / 2) * horizontalSensitivity - 90;
    const y = rect.height / 2 - 50;
    return { x, y };
  }

  // Update menu position
  function updateMenuPosition() {
    const lRect = leftContainer.getBoundingClientRect();
    const rRect = rightContainer.getBoundingClientRect();

    const targetL = worldToScreen(menuWorldYaw, menuWorldPitch, lRect);
    const targetR = worldToScreen(menuWorldYaw, menuWorldPitch, rRect);

    menuPos.xL = lerp(menuPos.xL, targetL.x, smoothing);
    menuPos.yL = lerp(menuPos.yL, targetL.y, smoothing);
    menuPos.xR = lerp(menuPos.xR, targetR.x, smoothing);
    menuPos.yR = lerp(menuPos.yR, targetR.y, smoothing);

    menuLeft.style.left = menuPos.xL + "px";
    menuLeft.style.top = menuPos.yL + "px";
    menuRight.style.left = menuPos.xR + "px";
    menuRight.style.top = menuPos.yR + "px";

    menuLeft.style.visibility = "visible";
    menuRight.style.visibility = "visible";
  }

  // Initialize XR
  initXR();
</script>

</body>
</html>
