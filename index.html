<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>XR Hand Tracking UI</title>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
        "@tensorflow/tfjs-backend-webgl": "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.20.0/dist/tf-backend-webgl.esm.js",
        "@tensorflow-models/handpose": "https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.esm.js"
      }
    }
  </script>

  <style>
    html, body {
      margin: 0; padding: 0;
      overflow: hidden;
      background-color: black;
      font-family: 'Segoe UI', sans-serif;
    }

    #startButton {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      font-size: 22px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: background 0.3s;
    }
    #startButton:hover {
      background: rgba(255,255,255,0.2);
    }

    #fadeOverlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      z-index: 10;
      opacity: 1;
      transition: opacity 2s ease;
    }
  </style>
</head>

<body>
  <div id="fadeOverlay"></div>
  <button id="startButton">Start VR</button>
  <script type="module">
    import * as THREE from 'three';
    import { initHandTracking } from './hand-tracking.js';
    import { initMenuTracking } from './menu-tracking.js';

    let scene, camera, renderer, menu;
    let vrSession = null;
    const fadeOverlay = document.getElementById('fadeOverlay');
    const startButton = document.getElementById('startButton');

    initScene();

    startButton.addEventListener('click', async () => {
      startButton.style.display = 'none';
      await flyThroughIntro();
      await startVR();
    });

    function initScene() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);
      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    async function flyThroughIntro() {
      fadeOverlay.style.opacity = 1;
      await new Promise(r => setTimeout(r, 300));
      fadeOverlay.style.transition = 'opacity 3s ease';
      fadeOverlay.style.opacity = 0;

      // simple 3D tunnel-like animation
      const geo = new THREE.TorusGeometry(3, 0.2, 16, 100);
      const mat = new THREE.MeshBasicMaterial({ color: 0x0077ff, wireframe: true });
      const tunnel = new THREE.Mesh(geo, mat);
      scene.add(tunnel);

      let t = 0;
      return new Promise(resolve => {
        const animate = () => {
          t += 0.02;
          camera.position.z -= 0.05;
          tunnel.rotation.x += 0.02;
          tunnel.rotation.y += 0.03;
          if (t < 5) {
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
          } else {
            scene.remove(tunnel);
            resolve();
          }
        };
        animate();
      });
    }

    async function startVR() {
      if (navigator.xr) {
        vrSession = await navigator.xr.requestSession('immersive-vr', { requiredFeatures: ['local-floor'] });
        renderer.xr.setSession(vrSession);

        // create frosted glass menu plane
        const menuGeometry = new THREE.PlaneGeometry(0.8, 0.5);
        const menuMaterial = new THREE.MeshPhysicalMaterial({
          color: 0xffffff,
          transparent: true,
          opacity: 0.25,
          roughness: 0.2,
          metalness: 0.1,
          transmission: 0.8,
          thickness: 0.02,
          envMapIntensity: 1.0
        });
        menu = new THREE.Mesh(menuGeometry, menuMaterial);
        menu.position.set(0, 1.3, -1.5);
        scene.add(menu);

        initHandTracking(scene, camera, menu);
        initMenuTracking(menu);

        renderer.setAnimationLoop(() => renderer.render(scene, camera));
      } else {
        alert('WebXR not supported or 6DOF unavailable on this device.');
      }
    }
  </script>
</body>
</html>
