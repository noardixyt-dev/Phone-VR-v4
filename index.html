<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stereo VR Phone Viewer</title>
<style>
  body, html { margin:0; padding:0; overflow:hidden; background:black; }
  #cameraFeedLeft, #cameraFeedRight {
    position:absolute; top:0; width:auto; height:auto; object-fit:cover;
  }
  #eyeWindowLeft, #eyeWindowRight {
    position:absolute; border:2px solid gray; overflow:hidden;
    background:black;
  }
  #uiControls {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    display:flex; gap:10px; opacity:0; transition:opacity 0.3s;
  }
  button, input { font-size:16px; }
  #menu {
    position:absolute; width:50%; height:50%; background:rgba(255,255,255,0.9);
    border-radius:10px; display:none; transition:all 0.3s;
  }
</style>
</head>
<body>

<video id="cameraFeed" autoplay playsinline style="display:none;"></video>

<div id="eyeWindowLeft"></div>
<div id="eyeWindowRight"></div>

<div id="uiControls">
  <button id="fullscreenBtn">Fullscreen</button>
  <input id="fovSlider" type="range" min="50" max="100" value="70">
  <button id="debugToggle">Debug</button>
</div>

<div id="menu">MENU CONTENT</div>

<script>
const cameraFeed = document.getElementById('cameraFeed');
const eyeLeft = document.getElementById('eyeWindowLeft');
const eyeRight = document.getElementById('eyeWindowRight');
const uiControls = document.getElementById('uiControls');
const menu = document.getElementById('menu');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const fovSlider = document.getElementById('fovSlider');
const debugToggle = document.getElementById('debugToggle');

let eyeWindowRatio = 1.5; // 1.5:1 width:height
let eyeWindowScale = parseInt(fovSlider.value)/100;
let gapPixels = 10;
let menuVisible = false;

// Request rear camera with highest resolution fallback
async function startCamera() {
  const constraints = {
    audio: false,
    video: {
      facingMode: { exact: "environment" },
      width: { ideal: 3840 },
      height: { ideal: 2160 }
    }
  };
  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    cameraFeed.srcObject = stream;
    cameraFeed.play();
    requestAnimationFrame(updateFrames);
  } catch (e) {
    console.error("Camera error:", e);
  }
}

function updateEyeWindows() {
  const screenW = window.innerWidth;
  const screenH = window.innerHeight;
  const windowHeight = screenH * eyeWindowScale;
  const windowWidth = windowHeight * eyeWindowRatio;
  const dynamicGap = gapPixels * eyeWindowScale;

  // Top edge fixed, scale downward
  const top = 0;

  eyeLeft.style.width = windowWidth + 'px';
  eyeLeft.style.height = windowHeight + 'px';
  eyeLeft.style.top = top + 'px';
  eyeLeft.style.left = (screenW/2 - windowWidth - dynamicGap/2) + 'px';

  eyeRight.style.width = windowWidth + 'px';
  eyeRight.style.height = windowHeight + 'px';
  eyeRight.style.top = top + 'px';
  eyeRight.style.left = (screenW/2 + dynamicGap/2) + 'px';
}

function updateFrames() {
  const screenW = window.innerWidth;
  const screenH = window.innerHeight;

  const videoW = cameraFeed.videoWidth;
  const videoH = cameraFeed.videoHeight;
  if(videoW && videoH){
    // Fit video inside eye windows while cropping overflow
    [eyeLeft, eyeRight].forEach(eye=>{
      const eyeW = parseFloat(eye.style.width);
      const eyeH = parseFloat(eye.style.height);
      const scale = Math.max(eyeW/videoW, eyeH/videoH);
      const vw = videoW * scale;
      const vh = videoH * scale;
      eye.style.backgroundImage = `url(${cameraFeed.srcObject ? cameraFeed.srcObject : ''})`;
      eye.style.backgroundSize = `${vw}px ${vh}px`;
      eye.style.backgroundPosition = `center center`;
      eye.style.backgroundRepeat = 'no-repeat';
    });
  }

  requestAnimationFrame(updateFrames);
}

// FOV Slider
fovSlider.addEventListener('input', ()=> {
  eyeWindowScale = parseInt(fovSlider.value)/100;
  updateEyeWindows();
});

// Fullscreen
fullscreenBtn.addEventListener('click', ()=> {
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
});

// Debug toggle
debugToggle.addEventListener('click', ()=>{
  alert("Debug toggled"); // placeholder
});

// Double tap to toggle menu
let lastTap = 0;
window.addEventListener('touchend', function(e) {
  const currentTime = new Date().getTime();
  const tapLength = currentTime - lastTap;
  if(tapLength < 300 && tapLength > 0){
    menuVisible = !menuVisible;
    menu.style.display = menuVisible ? 'block' : 'none';
  }
  lastTap = currentTime;
});

// Update positions
updateEyeWindows();
startCamera();
window.addEventListener('resize', updateEyeWindows);
</script>

</body>
</html>

