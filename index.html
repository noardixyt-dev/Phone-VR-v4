<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VR Viewer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      touch-action: none;
      user-select: none;
    }

    #vr-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      z-index: 0;
    }

    canvas {
      display: none;
    }

    .eye-window {
      width: 48%;
      height: 90%;
      overflow: hidden;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      position: relative;
      z-index: 1;
    }

    #ui {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: row;
      gap: 10px;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 5;
    }

    #ui.hidden {
      opacity: 0;
    }

    button, input[type=range] {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }

    #debug-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: limegreen;
      font-family: monospace;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.5);
      padding: 4px 8px;
      border-radius: 6px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    #debug-info.visible {
      opacity: 1;
    }
  </style>
</head>
<body>

  <div id="vr-container">
    <div class="eye-window" id="left-eye"></div>
    <div class="eye-window" id="right-eye"></div>
    <video id="camera" autoplay playsinline muted></video>
    <canvas id="buffer"></canvas>
  </div>

  <div id="ui">
    <button id="fullscreen">Fullscreen</button>
    <input id="fov-slider" type="range" min="60" max="120" value="90">
    <button id="debug-toggle">Debug Info</button>
  </div>

  <div id="debug-info"></div>

  <script>
    const video = document.getElementById("camera");
    const leftEye = document.getElementById("left-eye");
    const rightEye = document.getElementById("right-eye");
    const fovSlider = document.getElementById("fov-slider");
    const ui = document.getElementById("ui");
    const fullscreenBtn = document.getElementById("fullscreen");
    const debugToggle = document.getElementById("debug-toggle");
    const debugInfo = document.getElementById("debug-info");
    let uiTimeout;
    let showDebug = false;

    // --- Camera Setup ---
    async function startCamera() {
      const constraintsList = [
        { video: { facingMode: { exact: "environment" }, width: { ideal: 3840 }, height: { ideal: 2160 } } },
        { video: { facingMode: "environment", width: { ideal: 3840 }, height: { ideal: 2160 } } },
        { video: { facingMode: { ideal: "rear" }, width: { ideal: 3840 }, height: { ideal: 2160 } } },
        { video: { width: { ideal: 3840 }, height: { ideal: 2160 } } }
      ];

      for (const constraints of constraintsList) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          const track = stream.getVideoTracks()[0];
          const settings = track.getSettings();
          debugInfo.textContent = `Camera: ${settings.facingMode || "unknown"} | ${settings.width}x${settings.height} | deviceId: ${track.getSettings().deviceId || "N/A"}`;
          console.log("Camera started:", settings);
          return;
        } catch (err) {
          console.warn("Camera request failed:", err);
        }
      }
      alert("Unable to access rear camera.");
    }

    // --- Stereo layout ---
    function updateFOV() {
      const fov = fovSlider.value;
      const scale = fov / 90;
      leftEye.style.transform = `scale(${scale})`;
      rightEye.style.transform = `scale(${scale})`;
    }

    // --- UI visibility logic ---
    function resetUITimeout() {
      clearTimeout(uiTimeout);
      ui.classList.remove("hidden");
      uiTimeout = setTimeout(() => ui.classList.add("hidden"), 10000);
    }

    // --- Debug Info Toggle ---
    debugToggle.addEventListener("click", () => {
      showDebug = !showDebug;
      if (showDebug) debugInfo.classList.add("visible");
      else debugInfo.classList.remove("visible");
      resetUITimeout();
    });

    // --- Fullscreen ---
    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
      resetUITimeout();
    });

    // --- FOV ---
    fovSlider.addEventListener("input", updateFOV);

    // --- Tap Top to Show UI ---
    window.addEventListener("touchstart", e => {
      if (e.touches[0].clientY < window.innerHeight * 0.2) resetUITimeout();
    });

    // --- Double Tap for Menu Toggle (placeholder) ---
    let lastTap = 0;
    window.addEventListener("touchend", () => {
      const now = Date.now();
      if (now - lastTap < 400) {
        // menu toggle logic placeholder
      }
      lastTap = now;
    });

    // --- Assign video as background to both eyes ---
    function attachVideoToEyes() {
      leftEye.appendChild(video.cloneNode());
      rightEye.appendChild(video);
      const videos = document.querySelectorAll("video");
      videos.forEach(v => {
        v.srcObject = video.srcObject;
        v.play();
      });
    }

    startCamera().then(() => attachVideoToEyes());
    updateFOV();
    resetUITimeout();
  </script>
</body>
</html>
